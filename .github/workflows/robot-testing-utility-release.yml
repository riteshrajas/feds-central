# =============================================================================
# robot-testing-utility Release
# =============================================================================
#
# Triggered when a tag matching rtu/v* is pushed (e.g., rtu/v1.0.0).
#
# Steps:
#   1. Build and test the library
#   2. Create a GitHub Release named after the tag
#   3. Upload robot-testing-utility-<version>.jar as a release asset
#
# Tag format:  rtu/v<semver>   (e.g. rtu/v1.0.0, rtu/v1.2.3-beta)
# =============================================================================

name: robot-testing-utility Release

on:
  push:
    tags:
      - 'rtu/v*'

jobs:
  release:
    name: Build & Release JAR
    runs-on: ubuntu-latest
    permissions:
      contents: write   # needed to create GitHub Releases and upload assets

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Grant execute permission for gradlew
        working-directory: robot/robot-testing-utility
        run: chmod +x gradlew

      - name: Extract version from tag
        id: version
        # Tag is like rtu/v1.0.0 — strip the rtu/v prefix
        run: echo "version=${GITHUB_REF_NAME#rtu/v}" >> "$GITHUB_OUTPUT"

      - name: Build and test
        working-directory: robot/robot-testing-utility
        run: ./gradlew build -Pgpr.version=${{ steps.version.outputs.version }}

      - name: Find JAR artifact
        id: jar
        working-directory: robot/robot-testing-utility
        run: |
          jar_path=$(ls build/libs/robot-testing-utility-*.jar | head -1)
          echo "path=$jar_path" >> "$GITHUB_OUTPUT"
          echo "name=$(basename $jar_path)" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release and upload JAR
        uses: softprops/action-gh-release@v2
        with:
          name: "robot-testing-utility v${{ steps.version.outputs.version }}"
          tag_name: ${{ github.ref_name }}
          body: |
            ## robot-testing-utility v${{ steps.version.outputs.version }}

            Standalone FRC robot test harness — auto-discovers and runs `@RobotAction` methods on your subsystems in Test mode.

            ### Installing in your robot project

            **`settings.gradle`**
            ```groovy
            include ':robot-testing-utility'
            project(':robot-testing-utility').projectDir = new File(settingsDir, '../robot-testing-utility')
            ```

            **`build.gradle`**
            ```groovy
            dependencies {
                implementation project(':robot-testing-utility')
            }
            ```

            Or download the JAR below and add it to your `libs/` folder:
            ```groovy
            dependencies {
                implementation fileTree(dir: 'libs', include: ['*.jar'])
            }
            ```

            See the [README](https://github.com/${{ github.repository }}/blob/main/robot/robot-testing-utility/README.md) for full documentation.
          files: robot/robot-testing-utility/${{ steps.jar.outputs.path }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
